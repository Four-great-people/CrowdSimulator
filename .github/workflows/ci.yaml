name: ci

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["*"]

jobs:
  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: make environment
        run: |
          sudo apt update
          sudo apt install -y wget cmake g++
          sudo apt install -y libasio-dev zlib1g-dev libssl-dev libgtest-dev libgmock-dev
          wget https://github.com/CrowCpp/Crow/releases/download/v1.2.1.2/Crow-1.2.1-Linux.deb
          sudo dpkg -i Crow-1.2.1-Linux.deb
      
      - name: set cmake
        run: |
          cd backend
          mkdir build
          cd build
          cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 ..
      
      - name: build
        run: |
          cd backend/build
          make backend
      
      - name: lint
        run: |
          sudo apt install -y cppcheck clang-tidy cpplint
          cd backend
          cppcheck --enable=all --inconclusive -I main/include -I main/lib -I test/include --suppress=missingIncludeSystem main test --inline-suppr --force --error-exitcode=1
          run-clang-tidy -p build/ -extra-arg=-std=c++20 -warnings-as-errors='*'
          cpplint --filter=-build/include_subdir,-legal/copyright,-build/header_guard,-runtime/references,-build/c++11  --recursive main/src main/include test/src

  build-test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: make environment
        run: |
          sudo apt update
          sudo apt install -y wget cmake g++
          sudo apt install -y libasio-dev zlib1g-dev libssl-dev libgtest-dev libgmock-dev
          wget https://github.com/CrowCpp/Crow/releases/download/v1.2.1.2/Crow-1.2.1-Linux.deb
          sudo dpkg -i Crow-1.2.1-Linux.deb
      
      - name: set cmake
        run: |
          cd backend
          mkdir build
          cd build
          cmake ..
      
      - name: build
        run: |
          cd backend/build
          make backend
      
      - name: test
        run: |
          cd backend/build
          make backend_test
          ./backend_test
      
      - name: asan test
        run: |
          cd backend/build
          make backend_test_sans
          ./backend_test_sans
      
      - name: tsan test
        run: |
          cd backend/build
          make backend_test_tsan
          ./backend_test_tsan

  build-integration-test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: make cpp environment
        run: |
          sudo apt update
          sudo apt install -y wget cmake g++
          sudo apt install -y libasio-dev zlib1g-dev libssl-dev libgtest-dev libgmock-dev
          wget https://github.com/CrowCpp/Crow/releases/download/v1.2.1.2/Crow-1.2.1-Linux.deb
          sudo dpkg -i Crow-1.2.1-Linux.deb
      
      - name: set cmake and build
        run: |
          cd backend
          mkdir build
          cd build
          cmake ..
          make backend

      - name: make python environment
        run: |
          sudo apt install python3-pip
          python3 -m pip config set global.break-system-packages true
          cd backend
          pip3 install -r requirements.txt
      
      - name: run server and test
        run: |
          cd backend/build
          ./backend &
          SERVER_PID=$!
          cleanup() {
            echo "Cleaning up..."
            kill $SERVER_PID 2>/dev/null || true
            sleep 2
            kill -9 $SERVER_PID 2>/dev/null || true
          }
          trap cleanup EXIT
          sleep 5
          cd ../integration_tests
          echo "Running tests..."
          timeout 300 pytest -q test_web_server.py
          echo "Test were run"
          cleanup

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: make environment
        run: |
          sudo apt update
          sudo apt install npm nodejs curl
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
          \. "$HOME/.nvm/nvm.sh"
          nvm install 22
          cd frontend
          npm install

      - name: build
        run: |
          cd frontend
          npm run build
  
  test-middle-end:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: make environment
        run: |
          sudo apt update
          sudo apt install python3-pip
          python3 -m pip config set global.break-system-packages true
          cd middle-services
          pip3 install -r requirements.txt

      - name: mock-tests
        run: |
          cd middle-services
          pytest -q tests_api

  lint-middle-end:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: make environment
        run: |
          sudo apt update
          sudo apt install python3-pip
          python3 -m pip config set global.break-system-packages true
          cd middle-services
          pip3 install -r requirements.txt

      - name: lint
        run: |
          cd middle-services
          pylint --ignore=.venv,pycache,venv  --disable=missing-docstring,too-many-locals,too-many-instance-attributes,broad-exception-caught --recursive=y .
  test-crowddb-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        run: |
          sudo apt update
          sudo apt install -y python3-pip
          python3 -m pip config set global.break-system-packages true

      - name: Install deps
        working-directory: middle-services
        run: |
          pip3 install -r requirements.txt
          pip3 install mongomock

      - name: Run unit tests (mongomock)
        working-directory: middle-services/crowd_db
        run: |
          pytest -q tests

  test-crowddb-integration:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:4.4.6
        env:
          MONGO_INITDB_ROOT_USERNAME: user
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }

      - name: Install deps
        working-directory: middle-services
        run: |
          pip install -r requirements.txt

      # - name: Apply validator
      #   working-directory: middle-services
      #   env:
      #     MONGODB_URI: mongodb://127.0.0.1:27017/?replicaSet=rs0
      #     MONGODB_DB: crowdsim_test
      #   run: 

      - name: Run integration tests
        working-directory: middle-services
        env:
          MONGODB_URI: mongodb://127.0.0.1:27017/?replicaSet=rs0
          MONGODB_DB: crowdsim_test
        run: |
          mongod --shutdown;
          if [ ! -f /data/keyfile ]; then
              echo \"Генерация keyfile для реплика-сета...\"
              mkdir -p /data
              openssl rand -base64 756 > /data/keyfile
              chmod 400 /data/keyfile
              echo \"Keyfile создан\"
          fi;
          mongod --fork --logpath /dev/null --bind_ip_all --auth;
          sleep 1;
          mongo --eval \"
              db = db.getSiblingDB(\"admin\");
              db.createUser({
              user: \"user\",
              pwd: \"password\",
              roles: [{ role: \"root\", db: \"admin\" }]
              });
          \";
          sleep 1;
          mongod --shutdown;
          sleep 1;
          mongod --replSet rs0 --keyFile /data/keyfile --bind_ip_all --auth --fork --logpath /dev/null;
          sleep 1;
          mongo -u user -p password --verbose --eval \"rs.initiate()\";
          python3 -m crowd_db.scripts.setup_db || true
          pytest -q crowd_db/tests --integration 
